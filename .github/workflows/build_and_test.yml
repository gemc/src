# Build & Publish GitHub Container Registry (GHCR) Images
name: Build And Test Images
permissions:
  contents: read

on:
  push:
    branches: [ main ]   # publish on main updates
    tags: [ 'v*' ]       # also publish on version tags
  pull_request:          # PRs: build only (no push)

jobs:
  overview:
    name: Workflow Overview
    runs-on: ubuntu-latest
    steps:
      - name: Write overview
        shell: bash
        run: |
          : "${GITHUB_STEP_SUMMARY:=$RUNNER_TEMP/summary.md}"
          {
            echo "# GEMC Images — Overview"
            echo "Repository: [gemc images](https://github.com/gemc/src/pkgs/container/src)"
            echo "Except for archlinux (amd64-only), all images are built for both the *amd64* and *arm64* architectures."
            echo ""
            echo ""
            echo "Set these convenience variables for the command lines below (choose your own password)"
            echo '```bash'
            echo 'VPORTS=(-p 6080:6080 -p 5900:5900)'
            echo 'VNC_PASS=(-e X11VNC_PASSWORD=change-me)'
            echo 'VNC_BIND=(-e VNC_BIND=0.0.0.0)'
            echo 'GEO_FLAGS=(-e GEOMETRY=1920x1200)'
            echo 'VPLATFORM=" "'
            echo '```'
            echo ""
            echo "If your arch is arm64, (for example, MacOS silicon), and want to use the archlinux image, add this to all command lines:"
            echo '```bash'
            echo '--platform=linux/amd64'
            echo '```'
            echo "---"
          } >> "$GITHUB_STEP_SUMMARY"

  discover:
    name: Create Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      image: ${{ steps.scan.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - id: scan
        name: Build matrix
        run: ci/distros_tags.sh

  # ===========================
  # Per-arch build jobs
  # ===========================
  build_amd64:
    name: Build amd64 from ${{ matrix.osname }} ${{ matrix.osversion }}
    needs: [ overview, discover ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space
        with:
          prune_docker: "true"
          show_tree: "true"

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        name: Docker metadata (base tag)
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.discover.outputs.image }}
          tags: |
            type=raw,value=${{ format('{0}-{1}', matrix.gemc_tag, matrix.osname) }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.description=GEMC image (${{ matrix.gemc_tag }}, Geant4: ${{ matrix.geant4_tag }}) on ${{ matrix.baseimage }})

      - name: Generate Dockerfile
        run: |
          python3 ci/dockerfile_creator.py \
          -i "${{ matrix.baseimage }}" \
          -t "${{ matrix.gemc_tag }}" \
          > Dockerfile.generated
          cat Dockerfile.generated

      - name: Get upstream commit
        run: echo "UPSTREAM_REV=$(git ls-remote https://github.com/gemc/src HEAD | cut -f1)" >> $GITHUB_ENV

      - name: Buildx prune (pre-build safety)
        run: docker buildx prune -af || true

      - name: Build & Push (amd64 only)
        uses: docker/build-push-action@v5
        with:
          pull: true
          # no-cache: true   # keep removed to leverage cache
          build-args: |
            UPSTREAM_REV=${{ env.UPSTREAM_REV }}
          context: .
          file: ./Dockerfile.generated
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}-amd64
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ needs.discover.outputs.image }}:cache-amd64
          cache-to: type=registry,ref=${{ needs.discover.outputs.image }}:cache-amd64,mode=max

      # NEW: export logs from the logs-export stage to local disk (no docker pull)
      - name: Export logs (amd64)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.generated
          # Build only the tiny logs stage; reuse previous cache so it doesn't rebuild.
          target: logs-export
          platforms: linux/amd64
          push: false
          cache-from: type=registry,ref=${{ needs.discover.outputs.image }}:cache-amd64
          outputs: type=local,dest=${{ runner.temp }}/artifacts/logs-amd64

      - name: Upload logs artifact (amd64)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.gemc_tag }}-${{ matrix.osname }}-amd64
          path: ${{ runner.temp }}/artifacts/logs-amd64/logs
          if-no-files-found: ignore

      - name: Summary
#        if: ${{ always() }}
        if: ${{ false }}
        shell: bash
        env:
          IMAGE: ${{ needs.discover.outputs.image }}
          TAG: ${{ format('{0}-{1}', matrix.gemc_tag, matrix.osname) }}
        run: |
          OUT="$RUNNER_TEMP/summary.md"
          : "${GITHUB_STEP_SUMMARY:=$RUNNER_TEMP/step_summary.md}"
          {
            echo "## \`${TAG}\`"
            echo ""
            echo "### Pull"
            echo '```bash'
            echo "docker pull ${IMAGE}:${TAG}"
            echo '```'
            echo ""
            echo "### Run interactive shell"
            echo '```bash'
            echo "docker run --rm -it ${IMAGE}:${TAG} bash -l"
            echo '```'
            echo ""
            echo "### Run with VNC/noVNC"
            echo "_VNC → localhost:5900 (password: change-me)_"
            echo "_noVNC → http://localhost:6080/vnc.html (password: change-me)_"
            echo '```bash'
            echo "docker run --rm -it \$VPORTS \$VNC_BIND \$VNC_PASS \$GEO_FLAGS ${IMAGE}:${TAG}"
            echo '```'
          } | tee -a "$GITHUB_STEP_SUMMARY" > "$OUT"

      - name: Upload summary artifact (amd64)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ matrix.gemc_tag }}-${{ matrix.osname }}-amd64
          path: ${{ runner.temp }}/summary.md
          if-no-files-found: ignore

  # build_arm64 job header
  build_arm64:
    name: Build arm64 from ${{ matrix.osname }} ${{ matrix.osversion }}
    needs: [ overview, discover ]
    runs-on: ubuntu-24.04-arm   # <— use native ARM64 runner
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}


    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Optional: say why we’re skipping
      - name: Skip note (archlinux is amd64-only)
        if: ${{ matrix.osname == 'archlinux' }}
        run: echo "Skipping arm64 build for archlinux"

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space
        with:
          prune_docker: "true"
          show_tree: "true"

      - name: Set up Buildx
        if: ${{ matrix.osname != 'archlinux' }}
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: ${{ matrix.osname != 'archlinux' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        if: ${{ matrix.osname != 'archlinux' }}
        name: Docker metadata (base tag)
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.discover.outputs.image }}
          tags: |
            type=raw,value=${{ format('{0}-{1}', matrix.gemc_tag, matrix.osname) }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.description=GEMC image (${{ matrix.gemc_tag }}, Geant4: ${{ matrix.geant4_tag }}) on ${{ matrix.baseimage }})

      - name: Generate Dockerfile
        if: ${{ matrix.osname != 'archlinux' }}
        run: |
          python3 ci/dockerfile_creator.py \
          -i "${{ matrix.baseimage }}" \
          -t "${{ matrix.gemc_tag }}" \
          > Dockerfile.generated
          cat Dockerfile.generated

      - name: Get upstream commit
        if: ${{ matrix.osname != 'archlinux' }}
        run: echo "UPSTREAM_REV=$(git ls-remote https://github.com/gemc/src HEAD | cut -f1)" >> $GITHUB_ENV

      - name: Buildx prune (pre-build safety)
        run: docker buildx prune -af || true

      - name: Build & Push (arm64 only)
        if: ${{ matrix.osname != 'archlinux' }}
        uses: docker/build-push-action@v5
        with:
          pull: true
          context: .
          file: ./Dockerfile.generated
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}-arm64
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ needs.discover.outputs.image }}:cache-arm64
          cache-to: type=registry,ref=${{ needs.discover.outputs.image }}:cache-arm64,mode=max

      - name: Export logs (arm64)
        if: ${{ matrix.osname != 'archlinux' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.generated
          target: logs-export
          platforms: linux/arm64
          push: false
          cache-from: type=registry,ref=${{ needs.discover.outputs.image }}:cache-arm64
          outputs: type=local,dest=${{ runner.temp }}/artifacts/logs-arm64

      - name: Upload logs artifact (arm64)
        if: ${{ always() && matrix.osname != 'archlinux' }}
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.gemc_tag }}-${{ matrix.osname }}-arm64
          path: ${{ runner.temp }}/artifacts/logs-arm64/logs
          if-no-files-found: ignore


  # ===========================
  # Manifest stitch (same matrix)
  # ===========================
  manifest:
    name: Manifest for ${{ matrix.osname }}
    needs: [ build_amd64, build_arm64, discover ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    # If arm64 was skipped (e.g., archlinux), still publish amd64-only manifest.
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - name: Free up disk space
        uses: ./.github/actions/free-disk-space
        with:
          prune_docker: "true"
          show_tree: "true"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        name: Docker metadata (base tag)
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.discover.outputs.image }}
          tags: |
            type=raw,value=${{ format('{0}-{1}', matrix.gemc_tag, matrix.osname) }}

      - name: Buildx prune (pre-build safety)
        run: docker buildx prune -af || true

      - name: Create multi-arch manifest
        shell: bash
        run: |
          BASE_TAG="${{ steps.meta.outputs.tags }}"
          AMD_TAG="${BASE_TAG}-amd64"
          ARM_TAG="${BASE_TAG}-arm64"

          # If the arm64 build was skipped (e.g., archlinux), only include amd64
          if docker buildx imagetools inspect "$ARM_TAG" >/dev/null 2>&1; then
            docker buildx imagetools create -t "$BASE_TAG" "$AMD_TAG" "$ARM_TAG"
          else
            docker buildx imagetools create -t "$BASE_TAG" "$AMD_TAG"
          fi

      - name: Summary (manifest)
        if: ${{ always() }}
        shell: bash
        env:
          IMAGE: ${{ needs.discover.outputs.image }}
          TAG: ${{ format('{0}-{1}', matrix.gemc_tag, matrix.osname) }}
        run: |
          : "${GITHUB_STEP_SUMMARY:=$RUNNER_TEMP/manifest_summary.md}"
          {
            echo "## \`${IMAGE}:${TAG}\`"
            echo ""
            echo "Includes:"
            if docker buildx imagetools inspect "${IMAGE}:${TAG}-amd64" >/dev/null 2>&1; then echo "- amd64"; fi
            if docker buildx imagetools inspect "${IMAGE}:${TAG}-arm64" >/dev/null 2>&1; then echo "- arm64"; else echo "- arm64 (skipped)"; fi
            echo ""
            echo "### Pull"
            echo '```bash'
            echo "docker pull \$VPLATFORM ${IMAGE}:${TAG}"
            echo '```'
            echo ""
            echo "### Run (interactive)"
            echo '```bash'
            echo "docker run --rm -it ${IMAGE}:${TAG} bash -l"
            echo '```'
            echo ""
            echo "### Run with VNC/noVNC"
            echo "_VNC → localhost:5900 (password: change-me)_"
            echo "_noVNC → http://localhost:6080/vnc.html (password: change-me)_"
            echo '```bash'
            echo "docker run --rm -it \$VPORTS \$VNC_BIND \$VNC_PASS \$GEO_FLAGS ${IMAGE}:${TAG}"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

          # Also save a copy inside the workspace for artifact upload
          mkdir -p "$GITHUB_WORKSPACE/summaries"
          cp "$GITHUB_STEP_SUMMARY" "$GITHUB_WORKSPACE/summaries/summary-${{ matrix.gemc_tag }}-${{ matrix.image }}-${{ job.status }}.md" || true
          echo "Wrote $GITHUB_WORKSPACE/summaries/summary-${{ matrix.gemc_tag }}-${{ matrix.image }}.md"
          ls -l "$GITHUB_WORKSPACE/summaries"

      - name: Upload summary artifact (manifest)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ matrix.gemc_tag }}-${{ matrix.image }}-manifest
          path: |
            ${{ runner.temp }}/manifest_summary.md
            ${{ runner.temp }}/artifacts
          if-no-files-found: warn

